{% extends "layouts/base.html" %}

{% block content %}
<div class="dashboard-card">
    <h3>Channel Configuration</h3>

    {% if error %}
    <div class="alert alert-error">{{ error }}</div>
    {% endif %}

    {% if not telegram_authorized %}
    <div class="alert alert-error">
        Please authorize your Telegram account first.
        <a href="{{ url_for('authorization') }}" class="btn btn-primary">Authorize Telegram</a>
    </div>
    {% else %}
    <form id="channel-form" class="dashboard-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="form-group">
            <label>Source Channel</label>
            <select id="source-channel" class="form-control" required>
                <option value="">Select Source Channel</option>
                {% for channel in channels %}
                <option value="{{ channel.id }}" {% if channel.id == source_channel %}selected{% endif %}>
                    {{ channel.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label>Destination Channel</label>
            <select id="dest-channel" class="form-control" required>
                <option value="">Select Destination Channel</option>
                {% for channel in channels %}
                <option value="{{ channel.id }}" {% if channel.id == dest_channel %}selected{% endif %}>
                    {{ channel.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <h4>Active Replacements</h4>
            {% if replacements %}
            <div class="replacements-preview">
                {% for original, replacement in replacements.items() %}
                <div class="replacement-badge">
                    {{ original }} â†’ {{ replacement }}
                </div>
                {% endfor %}
            </div>
            <a href="{{ url_for('replacements') }}" class="btn btn-secondary">Manage Replacements</a>
            {% else %}
            <p>No replacements configured</p>
            <a href="{{ url_for('replacements') }}" class="btn btn-primary">Add Replacements</a>
            {% endif %}
        </div>

        <div class="form-group">
            <button type="button" id="save-config" class="btn btn-primary">Save Configuration</button>
        </div>

        {% if source_channel and dest_channel %}
        <div class="form-group" id="toggle-container">
            <div class="control-group">
                <label class="switch">
                    <input type="checkbox" id="bot-toggle" {% if bot_status %}checked{% endif %}>
                    <span class="slider round"></span>
                </label>
                <span>{{ "Stop" if bot_status else "Start" }} Forwarding</span>
            </div>
        </div>
        {% endif %}
    </form>
    {% endif %}
</div>

<script>
let configSaved = {% if source_channel and dest_channel %}true{% else %}false{% endif %};

async function saveConfiguration() {
    try {
        const source = document.getElementById('source-channel').value;
        const dest = document.getElementById('dest-channel').value;
        const token = document.querySelector('input[name="csrf_token"]').value;

        if (!source || !dest) {
            showMessage('Please select both source and destination channels', true);
            return;
        }

        if (source === dest) {
            showMessage('Source and destination channels cannot be the same', true);
            return;
        }

        const response = await fetch('/update-channels', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': token
            },
            body: `source=${encodeURIComponent(source)}&destination=${encodeURIComponent(dest)}`
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || `Request failed with status ${response.status}`);
        }

        configSaved = true;
        showMessage('Channel configuration saved successfully');

        // Show toggle container
        const toggleContainer = document.getElementById('toggle-container');
        if (!toggleContainer) {
            location.reload();
        } else {
            toggleContainer.style.display = 'block';
        }
    } catch (error) {
        showMessage(error.message || 'An error occurred while saving configuration', true);
    }
}

async function toggleBot(element) {
    if (!configSaved) {
        showMessage('Please save the configuration first', true);
        element.checked = false;
        return;
    }

    const token = document.querySelector('input[name="csrf_token"]').value;

    try {
        const response = await fetch('/bot/toggle', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': token
            },
            body: `status=${element.checked}`
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || `Request failed with status ${response.status}`);
        }

        showMessage(`Bot is now ${data.status ? 'running' : 'stopped'}`);
    } catch (error) {
        showMessage(error.message || 'An error occurred while toggling bot status', true);
        element.checked = !element.checked;
    }
}

function showMessage(message, isError = false) {
    // Remove any existing message
    const existingMessage = document.querySelector('.alert');
    if (existingMessage) {
        existingMessage.remove();
    }

    const messageDiv = document.createElement('div');
    messageDiv.className = `alert ${isError ? 'alert-error' : 'alert-success'}`;
    messageDiv.textContent = message;

    const form = document.getElementById('channel-form');
    form.insertBefore(messageDiv, form.firstChild);

    setTimeout(() => messageDiv.remove(), 5000);
}

document.getElementById('save-config').addEventListener('click', saveConfiguration);

if (document.getElementById('bot-toggle')) {
    document.getElementById('bot-toggle').addEventListener('change', function() {
        toggleBot(this);
    });
}
</script>

<style>
.dashboard-form {
    margin-bottom: 20px;
}

.form-group {
    margin-bottom: 15px;
}

.control-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

.alert {
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 4px;
}

.alert-error {
    background-color: #ffebee;
    color: #c62828;
    border: 1px solid #ef9a9a;
}

.alert-success {
    background-color: #e8f5e9;
    color: #2e7d32;
    border: 1px solid #a5d6a7;
}

.switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
}

.slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
}

input:checked + .slider {
    background-color: #2196F3;
}

input:checked + .slider:before {
    transform: translateX(26px);
}

.slider.round {
    border-radius: 34px;
}

.slider.round:before {
    border-radius: 50%;
}

.replacements-preview {
    margin: 10px 0;
    padding: 10px;
    background: #f5f5f5;
    border-radius: 4px;
}

.replacement-badge {
    display: inline-block;
    padding: 5px 10px;
    margin: 2px;
    background: #e0e0e0;
    border-radius: 15px;
    font-size: 0.9em;
}

#toggle-container {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #eee;
}

.btn {
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    border: none;
}

.btn-primary {
    background-color: #2196F3;
    color: white;
}

.btn-secondary {
    background-color: #757575;
    color: white;
}

.btn:hover {
    opacity: 0.9;
}
</style>
{% endblock %}